\section{Überblick}
\subsection{Analyse Datenbank BVG}
Die BVG nutzt für die Persistierung der Daten, inklusive der Prozessdaten, ein Datenbanksystem der Firma Oracle. Es werden bei der BVG zwischen zwei verschiedenen Systemen unterschieden. Zum Einen gibt es die sogenannte SC05 Schnittstelle. Diese enthält Prozessdaten der aktuellen Betriebslage. Dazu zählen unter anderem Positionen von Bussen und deren Verspätung (vgl.: "`Die Prozessdatenschnittstelle (SC05) spiegelt die aktuelle Situation im RBL wider."'). % TODO
Zum Anderen gibt es die SC51 Datenbank, entwickelt von der Firma Alcatel. Diese Schnittstelle enthält unterschiedlichste Daten für die Durchführung des öffentlichen Nahverkehrs der BVG. Darunter fallen Informationen zu Linien (Bus und Bahn), Informationen über deren Routen mittels geografischer Koordinaten und vieles mehr. 
Für die Analyse dieser relationalen Datenbanken waren jeweils Dokumentationen und ein Dump der Datenbank zur Verfügung.
 
Der erste Schritt bei der Analyse bestand darin, die Dumps der Oracle Datenbanken zu importieren, um anschließend Zugriff auf die Tabellen und deren Daten zu erlangen. Für den Import fiel die Entscheidung für das Tool "`OraDump to MySQL"'. % TODO https://www.convert-in.com/ord2sql.htm
Mit diesem Tool ist es möglich ein Oracle Datenbank Dump in eine MySQL Datenbank zu importieren. Vorteil dieser Methode ist, das auf bestehende Kenntnisse im Umgang mit MySQL zurückgegriffen werden kann. Im folgenden wurde mittels der Schnittstellendokumentation die Struktur der Datenbank analysiert. Im Fokus dieser Analyse stehen die Routen Information aus der SC51 und die Positionsdaten der Fahrzeuge aus der SC05 Schnittstelle. Bei der Analyse haben sich folgende Datenbanktabellen als wertvoll gezeigt. 
 
Die Tabelle \code{CM\_VEHICLE\_POSITION} aus der SC05 Datenbank enthält Informationen zu der aktuellen geografischen Position mittels Latitude und Longitude, der Abweichung vom Sollfahrplan in Sekunden, sowie eine Zuordnung zu einer Route. Um einen Omnibus auf einer Route einzuordnen, gibt es eine endliche Menge von geografischen Punkten. Zu all diesen Punkten ist ein zeitlicher und örtlicher Abstand bekannt (siehe SC51). Zu jedem Fahrzeug ist der letzte passierte Punkt der Route referenziert (\code{LAST\_POR\_ORDER}). Der prozentuale Abstand zum Folgepunkt auf einer Route ist ebenfalls in der Relation durch die Spalte \code{REL\_LNK\_DISTANCE} gegeben.

Für die Zuordnung der Fahrzeuge aus der Tabelle \code{CM\_VEHICLE\_POSITION} zu einer Route und einem Kurs gibt es in der SC05 Datenbank zwei Tabellen. Zum Einen hat die Tabelle \code{CM\_ACCT\_COURSES} die Aufgabe, ein Fahrzeug einem Kurs zuzuordnen. Zum Anderen wird durch \code{CM\_ACCT\_JOURNEY} ein Bus einer Route zugeordnet. Somit können die \code{POINTS\_ON\_ROUTE} einem Fahrzeug zugeordnet werden.

Die Datenbank SC51 beinhaltet Tabellen für die Linien (\code{LINES}). Eine Linie ist im Kontext der BVG zum Beispiel die konkrete Buslinie X11. Jede Linie besteht aus mehren Fahrten, hier \code{COURSES\_ON\_JOURNEY} genannt. Zu einem Kurs gehören Informationen wie Startzeit, Endzeit und eine Kursnummer, die nur im Kontext einer Linie eindeutig ist.

Die geografischen Informationen zum Routenverlauf werden in den Tabellen \code{ROUTE}, \code{POINTS\_ON\_ROUTE} und \code{NETWORK\_POINTS} verwaltet. Zu einer Buslinie können verschiedene Routen gehören. Diese Routen sind in der Tabelle \code{ROUTE} zu finden. Dafür enthält auch diese Relation zusätzlich ein Feld \code{Description} (Beispieldaten: Falkensee, Bahnhof->S+U Rathaus Spandau). Die Tabelle \code{POINTS\_ON\_ROUTE} koordiniert die Punkte einer Route, indem jeder Punkt einen Laufnummer hat (\code{POR\_ORDER}). Um den zeitlichen und örtlichen Abstand zwischen zwei Punkten zu ermitteln, wird die Relation \code{LINKS} verwendet. Die Tabelle \code{NETWORK\_POINTS} enthält abschließend die eigentlichen geografischen Punkte in der Form Latitude und Longitude.

In der Abbildung \ref{img:db-bvg} sind die Zusammenhänge der einzelnen Datenbanktabelle von SC05 und SC51 zu sehen. Dabei handelt es sich lediglich um einen Auszug der relevanten Daten für das zu entwickelnde System.

\begin{figure}[H]
	\centering
	\includegraphics[width=15cm]{res/BVG-DB.png}
	\caption{Datenbank Schema aus SC05 und SC51}
	\label{img:db-bvg}
\end{figure}

\subsection{OSM}
Wie kommt man an die Routen Infos zu den Bus-/Tram Linien. GeoJson.

\section{Komponenten}
Bestandteile des Systems beschreiben (Server, App, ...)

\input{ApiReferenz.tex}

\section{Datenbankschema Server}
Für die Persistierung der Daten des Servers wurde eine relationale Datenbank gewählt. Speziell für die Implementierung wird eine MySQL Datenbank gewählt. Um auf die Datenbank aus Java zuzugreifen, wird der Java Database Connector (JDBC) verwendet.

In der Datenbank werden Daten der Route und deren Geometrien aus OSM gespeichert. Dafür gibt es die Tabellen \code{Route}, \code{MultiLineString} und \code{LineString}. Die Relation \code{Route} enthält Informationen über die Liniennummern (\code{rel}), Start- und Zielhaltestelle (\code{from}, \code{to}). Zudem sind Informationen über das Verkehrsunternehmen (\code{operator}, Beispiel: BVG) und den Verkehrsverbund (\code{network}, Beispiel: VBB) vorhanden. Die Eigenschaft \code{type} entscheidet über den Typ der Geometrie einer Route. Die eigentliche Information über die Geometrie befindet sich als String in der Tabelle \code{MultiLineString} oder \code{LineString}. Ein solcher MultiLineString kann beispielsweise wie folgt aussehen: 
\begin{lstlisting}
MultiLineString((13.6920278 52.4516269, 13.6923877 52.4515733, 13.6926666 52.4515393, ...))
\end{lstlisting}

Um Aussagen über die Geschwindigkeit von Fahrzeugen auf einer Route treffen zu können, wurden im Vorfeld Testfahrten gemacht. Die gesammelten Daten während dieser Testfahrten sind in den Tabellen \code{Journey} und \code{MeasurePoint} persistiert. Die Tabelle \code{Journey} beschreibt eine spezielle Fahrt zu einer Uhrzeit auf einer Route. Die Messwerte, also die GPS Position eines Fahrzeugs und Zeitstempel, werden zu einer Fahrt in der Relation \code{MeasurePoint} gespeichert. Bei den GPS Daten handelt es sich um die ungeglätteten Daten, das hei{\ss}t also, dass die GPS Daten nicht zwingend auf der Route liegen.

In der Tabelle \code{Vehicle} werden die aktuellen Informationen zu den Fahrzeugen gespeichert. Dafür enthält die Tabelle Informationen zu GPS Position (geglättet), einen Zeitstempel und die Route eines Fahrzeuges. Jedes Fahrzeug wird über einen Unique Identifier identifiziert (\code{ref}).

Um diese Fahrzeugdaten historisch zu persistieren, gibt es zusätzlich  zu \code{Vehicle} die Relation \code{VehicleHistory}. In dieser Tabelle existiert die gleiche Struktur wie \code{Vehicle}. Zusätzlich gibt es noch einen künstlichen Primärschlüssel, um jede Zeile eindeutig zu identifizieren. Somit ist es möglich zu jedem Zeitpunkt herauszufinden, auf welcher Route und an welcher Stelle ein Fahrzeug zu einem Zeitpunkt war.

Die Abbildung \ref{img:db-server} visualisiert die erstellte Datenbankstruktur mit den Relationen und deren Beziehungen für den Server.

\begin{figure}[H]
	\centering
	\includegraphics[width=15cm]{res/Server-DB.png}
	\caption{Datenbank Schema Server}
	\label{img:db-server}
\end{figure}
